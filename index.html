<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>كفالاتي - قائمة الأطفال</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">
                <svg class="logo-svg" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="white" stroke-width="3"/>
                    <path d="M50 25 C30 25, 25 45, 25 50 C25 65, 35 75, 50 75 C65 75, 75 65, 75 50 C75 45, 70 25, 50 25" fill="white" opacity="0.9"/>
                    <circle cx="38" cy="45" r="3" fill="#667eea"/>
                    <circle cx="62" cy="45" r="3" fill="#667eea"/>
                    <path d="M45 55 Q50 60, 55 55" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="loading-text">كفالاتي</div>
            <div class="loading-subtext">جاري التحميل...</div>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="logout-btn" onclick="handleLogout()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17, 21 12, 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                خروج
            </button>
            
            <div class="user-welcome">
                <div class="user-avatar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="user-info">
                    <div class="user-greeting">أهلاً بكِ يا</div>
                    <div class="user-name" id="userName">...</div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="card stats-card">
            <div class="stats-label">إجمالي الكفالات</div>
            <div id="globalTotals" style="margin-top: 12px;">
                <div class="stats-amount" id="globalTotalILS">0 ₪</div>
                <div style="font-size: 18px; margin-top: 8px; opacity: 0.9;">
                    <span id="globalTotalUSD" style="margin-left: 12px;">0 $</span>
                    <span id="globalTotalJOD">0 د.أ</span>
                </div>
            </div>
        </div>

        <!-- Children List -->
        <div id="childrenList">
            <!-- Children will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state hidden">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <h3>لا يوجد أطفال مسجلين</h3>
            <p>اضغطي على الزر أدناه لإضافة طفل جديد</p>
        </div>
    </div>

    <!-- Add Child FAB -->
    <button class="btn btn-primary btn-fab" onclick="openAddChildModal()">
        <span>+</span>
        <span>إضافة طفل</span>
    </button>

    <!-- Add Child Modal -->
    <div id="addChildModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة طفل جديد</h3>
                <button class="modal-close" onclick="closeAddChildModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="form-group">
                <label>اسم الطفل</label>
                <input type="text" id="childName" placeholder="أدخل اسم الطفل">
            </div>
            <div class="form-group">
                <label>العمر</label>
                <input type="number" id="childAge" placeholder="أدخل عمر الطفل">
            </div>
            <button class="btn btn-primary" onclick="handleAddChild()">حفظ</button>
            <button class="btn btn-secondary mt-4" onclick="closeAddChildModal()">إلغاء</button>
        </div>
    </div>

    <script type="module">
        import { 
            initAuth, 
            loadChildren, 
            addChild, 
            deleteChild, 
            logout,
            showLoading,
            hideLoading,
            showToast,
            formatCurrency
        } from './js/app.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { db } from './js/firebase-config.js';

        let currentUser = null;

        // Check auth
        initAuth(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = user;
            
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
                document.getElementById('userName').textContent = userDoc.data().name;
            }
            
            await loadChildrenList();
        });

        async function loadChildrenList() {
            showLoading('جاري تحميل البيانات...');
            const children = await loadChildren();
            
            const listContainer = document.getElementById('childrenList');
            const emptyState = document.getElementById('emptyState');
            
            // حساب المجاميع العامة
            let globalILS = 0, globalUSD = 0, globalJOD = 0;

            if (children.length === 0) {
                listContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                hideLoading();
                return;
            }

            emptyState.classList.add('hidden');
            
            let html = '';
            children.forEach(child => {
                // جمع المجاميع العامة
                if (child.totalKafalat) {
                    globalILS += child.totalKafalat.ILS || 0;
                    globalUSD += child.totalKafalat.USD || 0;
                    globalJOD += child.totalKafalat.JOD || 0;
                }

                const totalILS = child.totalKafalat?.ILS || 0;
                const totalUSD = child.totalKafalat?.USD || 0;
                const totalJOD = child.totalKafalat?.JOD || 0;
                
                // بناء نص المجاميع
                let totalsHtml = '';
                if (totalILS > 0) totalsHtml += `<div style="font-weight: 700; color: var(--success);">${formatCurrency(totalILS, 'ILS')}</div>`;
                if (totalUSD > 0) totalsHtml += `<div style="font-size: 14px; color: var(--success); opacity: 0.9;">${formatCurrency(totalUSD, 'USD')}</div>`;
                if (totalJOD > 0) totalsHtml += `<div style="font-size: 14px; color: var(--success); opacity: 0.9;">${formatCurrency(totalJOD, 'JOD')}</div>`;

                html += `
                    <div class="card child-card animate-fade-in">
                        <div class="child-content" onclick="window.location.href='child.html?id=${child.id}'">
                            <div class="child-avatar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                            <div class="child-info">
                                <div class="child-name">${child.name}</div>
                                <div class="child-meta">${child.age} سنة • ${child.kafalatCount || 0} كفالات</div>
                            </div>
                            <div class="child-totals" style="text-align: left;">
                                ${totalsHtml}
                            </div>
                            <div class="child-arrow">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18, 15 12, 9 6"></polyline>
                                </svg>
                            </div>
                        </div>
                        <button class="btn-delete-icon" onclick="event.stopPropagation(); handleDeleteChild('${child.id}')" title="حذف">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6, 5 6, 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;
            });

            listContainer.innerHTML = html;

            // عرض المجاميع العامة
            document.getElementById('globalTotalILS').textContent = formatCurrency(globalILS, 'ILS');
            document.getElementById('globalTotalUSD').textContent = formatCurrency(globalUSD, 'USD');
            document.getElementById('globalTotalJOD').textContent = formatCurrency(globalJOD, 'JOD');

            // إخفاء العملات اللي مافيهن
            document.getElementById('globalTotalILS').style.display = globalILS > 0 ? 'block' : 'none';
            document.getElementById('globalTotalUSD').style.display = globalUSD > 0 ? 'inline' : 'none';
            document.getElementById('globalTotalJOD').style.display = globalJOD > 0 ? 'inline' : 'none';

            hideLoading();
        }

        window.openAddChildModal = function() {
            document.getElementById('addChildModal').classList.add('active');
            document.getElementById('childName').focus();
        };

        window.closeAddChildModal = function() {
            document.getElementById('addChildModal').classList.remove('active');
            document.getElementById('childName').value = '';
            document.getElementById('childAge').value = '';
        };

        window.handleAddChild = async function() {
            const name = document.getElementById('childName').value.trim();
            const age = document.getElementById('childAge').value;

            const childId = await addChild(name, age);
            if (childId) {
                closeAddChildModal();
                await loadChildrenList();
            }
        };

        window.handleDeleteChild = async function(childId) {
            if (!confirm('هل أنت متأكدة من حذف هذا الطفل وجميع كفالاته؟\nلا يمكن التراجع عن هذا الإجراء')) return;
            
            const success = await deleteChild(childId);
            if (success) {
                await loadChildrenList();
            }
        };

        window.handleLogout = async function() {
            await logout();
            window.location.href = 'login.html';
        };

        // Close modal on outside click
        document.getElementById('addChildModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddChildModal();
        });
    </script>
</body>
</html>
