<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>ÙƒÙØ§Ù„Ø§ØªÙŠ - ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·ÙÙ„</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-logo">ğŸ’š</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="logout-btn" onclick="goBack()">Ø±Ø¬ÙˆØ¹</button>
            <div class="header-icon">ğŸ‘¶</div>
            <h1 id="childName">Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</h1>
            <p id="childInfo">Ø§Ù„Ø¹Ù…Ø±: --</p>
        </div>

        <!-- Stats -->
        <div class="card stats-card">
            <div class="stats-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙØ§Ù„Ø§Øª</div>
            <div class="stats-amount" id="childTotal">0 â‚ª</div>
            <div class="stats-breakdown" id="statsBreakdown" style="margin-top: 8px; font-size: 13px; opacity: 0.9;"></div>
        </div>

        <!-- Kafalat List -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--dark);">Ø³Ø¬Ù„ Ø§Ù„ÙƒÙØ§Ù„Ø§Øª</h3>
            <div id="kafalatList"></div>
            <div id="emptyKafalat" class="empty-state hidden">
                <div class="empty-icon">ğŸ“</div>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙØ§Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
            </div>
        </div>
    </div>

    <!-- Add Kafala FAB -->
    <button class="btn btn-success btn-fab" onclick="openAddKafalaModal()">
        <span>+</span>
        <span>Ø¥Ø¶Ø§ÙØ© ÙƒÙØ§Ù„Ø©</span>
    </button>

    <!-- Add Kafala Modal -->
    <div id="addKafalaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ø¥Ø¶Ø§ÙØ© ÙƒÙØ§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <button class="modal-close" onclick="closeAddKafalaModal()">Ã—</button>
            </div>
            
            <div class="form-group" style="position: relative;">
                <label>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙƒØ§ÙÙ„Ø©</label>
                <input type="text" id="kafalaOrg" placeholder="Ø§Ø®ØªØ± Ø£Ùˆ Ø§ÙƒØªØ¨ Ø¬Ù‡Ø© Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="off" oninput="showSuggestions()">
                <div id="suggestions" class="suggestions hidden"></div>
            </div>

            <!-- Currency Selection -->
            <div class="form-group">
                <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                <div class="currency-selector">
                    <button type="button" class="currency-btn active" onclick="selectCurrency('ILS')">
                        <span style="font-size: 20px;">â‚ª</span>
                        <span style="font-size: 11px; display: block;">Ø´ÙŠÙƒÙ„</span>
                    </button>
                    <button type="button" class="currency-btn" onclick="selectCurrency('JOD')">
                        <span style="font-size: 20px;">Ø¯.Ø£</span>
                        <span style="font-size: 11px; display: block;">Ø¯ÙŠÙ†Ø§Ø±</span>
                    </button>
                    <button type="button" class="currency-btn" onclick="selectCurrency('USD')">
                        <span style="font-size: 20px;">$</span>
                        <span style="font-size: 11px; display: block;">Ø¯ÙˆÙ„Ø§Ø±</span>
                    </button>
                </div>
                <input type="hidden" id="kafalaCurrency" value="ILS">
            </div>

            <div class="form-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="kafalaAmount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">
            </div>
            <div class="form-group">
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="kafalaDate">
            </div>
            <div class="form-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="text" id="kafalaNotes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©">
            </div>
            <button class="btn btn-success" onclick="handleAddKafala()">Ø­ÙØ¸ Ø§Ù„ÙƒÙØ§Ù„Ø©</button>
            <button class="btn btn-secondary mt-4" onclick="closeAddKafalaModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal modal-confirm">
        <div class="modal-content confirm-content">
            <div class="confirm-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
            </div>
            <h3 class="confirm-title">Ø­Ø°Ù Ø§Ù„ÙƒÙØ§Ù„Ø©ØŸ</h3>
            <p class="confirm-text">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙØ§Ù„Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>
            <div class="confirm-buttons">
                <button class="btn btn-danger" id="confirmDeleteBtn">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { 
            initAuth, 
            loadKafalat, 
            addKafala, 
            deleteKafala,
            loadOrganizations,
            formatCurrency,
            formatDate,
            showLoading,
            hideLoading,
            showToast 
        } from './js/app.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { db, auth } from './js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        const childId = urlParams.get('id');

        if (!childId) {
            window.location.href = 'index.html';
        }

        let organizations = [];
        let kafalaToDelete = null;

        const currencySymbols = {
            'ILS': 'â‚ª',
            'JOD': 'Ø¯.Ø£',
            'USD': '$'
        };

        initAuth(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            await loadChildData();
            await loadKafalatList();
            organizations = await loadOrganizations();
        });

        async function loadChildData() {
            showLoading();
            try {
                const childDoc = await getDoc(doc(db, 'users', auth.currentUser.uid, 'children', childId));
                if (!childDoc.exists()) {
                    window.location.href = 'index.html';
                    return;
                }
                const child = childDoc.data();
                document.getElementById('childName').textContent = child.name;
                document.getElementById('childInfo').textContent = `Ø§Ù„Ø¹Ù…Ø±: ${child.age} Ø³Ù†Ø©`;
                hideLoading();
            } catch (error) {
                hideLoading();
                showToast('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'error');
            }
        }

        async function loadKafalatList() {
            const kafalat = await loadKafalat(childId);
            const listContainer = document.getElementById('kafalatList');
            const emptyState = document.getElementById('emptyKafalat');
            const totalElement = document.getElementById('childTotal');
            const breakdownElement = document.getElementById('statsBreakdown');

            // Ø­Ø³Ø§Ø¨ totals Ù„ÙƒÙ„ Ø¹Ù…Ù„Ø©
            let totals = { 'ILS': 0, 'JOD': 0, 'USD': 0 };
            kafalat.forEach(k => {
                const currency = k.currency || 'ILS';
                totals[currency] += k.amount;
            });

            // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø´ÙŠÙƒÙ„)
            totalElement.textContent = formatCurrency(totals['ILS']) + ' â‚ª';

            // Ø¹Ø±Ø¶ breakdown Ù„Ùˆ ÙÙŠ Ø¹Ù…Ù„Ø§Øª ØªØ§Ù†ÙŠØ©
            let breakdownHtml = '';
            if (totals['JOD'] > 0) {
                breakdownHtml += `<span style="margin-left: 12px;">${totals['JOD']} Ø¯.Ø£</span>`;
            }
            if (totals['USD'] > 0) {
                breakdownHtml += `<span style="margin-left: 12px;">${totals['USD']} $</span>`;
            }
            breakdownElement.innerHTML = breakdownHtml;

            if (kafalat.length === 0) {
                listContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            let html = '';
            kafalat.forEach(kafala => {
                const currency = kafala.currency || 'ILS';
                const symbol = currencySymbols[currency];
                
                html += `
                    <div class="kafala-item animate-fade-in">
                        <div class="kafala-icon">ğŸ’°</div>
                        <div class="kafala-details">
                            <div class="kafala-org">${kafala.organization}</div>
                            <div class="kafala-date">${formatDate(kafala.date)} ${kafala.notes ? 'â€¢ ' + kafala.notes : ''}</div>
                        </div>
                        <div class="kafala-amount">
                            ${kafala.amount} <span style="font-size: 14px;">${symbol}</span>
                        </div>
                        <button class="btn-delete-icon" onclick="openDeleteModal('${kafala.id}')" title="Ø­Ø°Ù">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        window.goBack = function() {
            window.location.href = 'index.html';
        };

        window.selectCurrency = function(currency) {
            document.getElementById('kafalaCurrency').value = currency;
            document.querySelectorAll('.currency-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        };

        window.openAddKafalaModal = function() {
            document.getElementById('addKafalaModal').classList.add('active');
            document.getElementById('kafalaDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('kafalaOrg').focus();
            // Reset currency to default
            document.getElementById('kafalaCurrency').value = 'ILS';
            document.querySelectorAll('.currency-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === 0);
            });
        };

        window.closeAddKafalaModal = function() {
            document.getElementById('addKafalaModal').classList.remove('active');
            document.getElementById('kafalaOrg').value = '';
            document.getElementById('kafalaAmount').value = '';
            document.getElementById('kafalaNotes').value = '';
            document.getElementById('suggestions').classList.add('hidden');
        };

        window.showSuggestions = function() {
            const input = document.getElementById('kafalaOrg').value.toLowerCase();
            const suggestionsDiv = document.getElementById('suggestions');
            if (!input || organizations.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            const filtered = organizations.filter(org => org.toLowerCase().includes(input));
            if (filtered.length > 0) {
                suggestionsDiv.innerHTML = filtered.map(org => 
                    `<div class="suggestion-item" onclick="selectOrg('${org}')">${org}</div>`
                ).join('');
                suggestionsDiv.classList.remove('hidden');
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        };

        window.selectOrg = function(org) {
            document.getElementById('kafalaOrg').value = org;
            document.getElementById('suggestions').classList.add('hidden');
        };

        window.handleAddKafala = async function() {
            const org = document.getElementById('kafalaOrg').value.trim();
            const amount = document.getElementById('kafalaAmount').value;
            const date = document.getElementById('kafalaDate').value;
            const notes = document.getElementById('kafalaNotes').value.trim();
            const currency = document.getElementById('kafalaCurrency').value;

            const success = await addKafala(childId, org, amount, date, notes, currency);
            if (success) {
                closeAddKafalaModal();
                await loadKafalatList();
            }
        };

        window.openDeleteModal = function(kafalaId) {
            kafalaToDelete = kafalaId;
            document.getElementById('deleteModal').classList.add('active');
        };

        window.closeDeleteModal = function() {
            kafalaToDelete = null;
            document.getElementById('deleteModal').classList.remove('active');
        };

        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (kafalaToDelete) {
                closeDeleteModal();
                const success = await deleteKafala(childId, kafalaToDelete);
                if (success) {
                    await loadKafalatList();
                }
            }
        });

        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) closeDeleteModal();
        });

        document.getElementById('addKafalaModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddKafalaModal();
        });
    </script>
</body>
</html>
