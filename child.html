<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>ÙƒÙØ§Ù„Ø§ØªÙŠ - ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·ÙÙ„</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Loading Screen - Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… ÙÙŠ index.html -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">
                <svg class="logo-svg" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="white" stroke-width="3"/>
                    <path d="M50 25 C30 25, 25 45, 25 50 C25 65, 35 75, 50 75 C65 75, 75 65, 75 50 C75 45, 70 25, 50 25" fill="white" opacity="0.9"/>
                    <circle cx="38" cy="45" r="3" fill="#667eea"/>
                    <circle cx="62" cy="45" r="3" fill="#667eea"/>
                    <path d="M45 55 Q50 60, 55 55" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="loading-text">ÙƒÙØ§Ù„Ø§ØªÙŠ</div>
            <div class="loading-subtext" id="loadingSubtext">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="logout-btn" onclick="goBack()">Ø±Ø¬ÙˆØ¹</button>
            <div class="header-icon">ğŸ‘¶</div>
            <h1 id="childName">Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</h1>
            <p id="childInfo">Ø§Ù„Ø¹Ù…Ø±: --</p>
        </div>

        <!-- Stats -->
        <div class="card stats-card">
            <div class="stats-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙØ§Ù„Ø§Øª</div>
            <div id="totalsContainer" style="margin-top: 12px;">
                <div class="stats-amount" id="childTotalILS">0 â‚ª</div>
                <div class="stats-amount" id="childTotalUSD" style="font-size: 24px; margin-top: 8px; opacity: 0.9;">0 $</div>
                <div class="stats-amount" id="childTotalJOD" style="font-size: 24px; margin-top: 8px; opacity: 0.9;">0 Ø¯.Ø£</div>
            </div>
        </div>

        <!-- Kafalat List -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--dark);">Ø³Ø¬Ù„ Ø§Ù„ÙƒÙØ§Ù„Ø§Øª</h3>
            <div id="kafalatList">
                <!-- Kafalat will be loaded here -->
            </div>
            <div id="emptyKafalat" class="empty-state hidden">
                <div class="empty-icon">ğŸ“</div>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙØ§Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
            </div>
        </div>
    </div>

    <!-- Add Kafala FAB -->
    <button class="btn btn-success btn-fab" onclick="openAddKafalaModal()">
        <span>+</span>
        <span>Ø¥Ø¶Ø§ÙØ© ÙƒÙØ§Ù„Ø©</span>
    </button>

    <!-- Add Kafala Modal -->
    <div id="addKafalaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ø¥Ø¶Ø§ÙØ© ÙƒÙØ§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <button class="modal-close" onclick="closeAddKafalaModal()">Ã—</button>
            </div>
            <div class="form-group" style="position: relative;">
                <label>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙƒØ§ÙÙ„Ø©</label>
                <input type="text" id="kafalaOrg" placeholder="Ø§Ø®ØªØ± Ø£Ùˆ Ø§ÙƒØªØ¨ Ø¬Ù‡Ø© Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="off" oninput="showSuggestions()">
                <div id="suggestions" class="suggestions hidden"></div>
            </div>
            <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                <div style="position: relative; width: 100%; font-family: 'Segoe UI', sans-serif;">
                    <button type="button" onclick="toggleCurrencyMenu()" id="currencyBtn" style="width: 100%; padding: 12px 16px; background: #fff; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 14px; transition: 0.3s; text-align: right;">
                        <span id="currencyText">Ø´ÙŠÙƒÙ„ â‚ª</span>
                        <span id="currencyArrow" style="transition: 0.3s;">â–¼</span>
                    </button>
                    
                    <div id="currencyMenu" style="position: absolute; top: 100%; right: 0; left: 0; background: #fff; border: 1px solid #ddd; border-radius: 0 0 8px 8px; margin-top: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s; z-index: 999;">
                        <div onclick="selectCurrency(this, 'ILS', 'Ø´ÙŠÙƒÙ„ â‚ª')" style="padding: 12px 16px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">Ø´ÙŠÙƒÙ„ â‚ª</div>
                        <div onclick="selectCurrency(this, 'USD', 'Ø¯ÙˆÙ„Ø§Ø± $')" style="padding: 12px 16px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #f0f0f0;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">Ø¯ÙˆÙ„Ø§Ø± $</div>
                        <div onclick="selectCurrency(this, 'JOD', 'Ø¯ÙŠÙ†Ø§Ø± Ø¯.Ø£')" style="padding: 12px 16px; cursor: pointer; transition: 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">Ø¯ÙŠÙ†Ø§Ø± Ø¯.Ø£</div>
                    </div>
                </div>
                <input type="hidden" id="selectedCurrency" value="ILS">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="kafalaAmount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">
            </div>
            <div class="form-group">
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="kafalaDate">
            </div>
            <div class="form-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="text" id="kafalaNotes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©">
            </div>
            <button class="btn btn-success" onclick="handleAddKafala()">Ø­ÙØ¸ Ø§Ù„ÙƒÙØ§Ù„Ø©</button>
            <button class="btn btn-secondary mt-4" onclick="closeAddKafalaModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script type="module">
        import { 
            initAuth, 
            loadKafalat, 
            addKafala, 
            deleteKafala,
            loadOrganizations,
            formatCurrency,
            formatDate,
            showToast 
        } from './js/app.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { db, auth } from './js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        const childId = urlParams.get('id');

        if (!childId) {
            window.location.href = 'index.html';
        }

        let organizations = [];

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø³Ù†Ø© - Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… ÙÙŠ index.html
        function showLoading(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
            const loadingScreen = document.getElementById('loadingScreen');
            const subtext = document.getElementById('loadingSubtext');
            if (subtext) subtext.textContent = message;
            loadingScreen.classList.remove('hidden');
        }

        function hideLoading() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.classList.add('hidden');
        }

        // Check auth and load data
        initAuth(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            await loadChildData();
            await loadKafalatList();
            organizations = await loadOrganizations();
        });

        async function loadChildData() {
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            try {
                const childDoc = await getDoc(doc(db, 'users', auth.currentUser.uid, 'children', childId));
                if (!childDoc.exists()) {
                    window.location.href = 'index.html';
                    return;
                }

                const child = childDoc.data();
                document.getElementById('childName').textContent = child.name;
                document.getElementById('childInfo').textContent = `Ø§Ù„Ø¹Ù…Ø±: ${child.age} Ø³Ù†Ø©`;
                hideLoading();
            } catch (error) {
                hideLoading();
                showToast('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'error');
            }
        }

        async function loadKafalatList() {
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙØ§Ù„Ø§Øª...');
            const kafalat = await loadKafalat(childId);
            const listContainer = document.getElementById('kafalatList');
            const emptyState = document.getElementById('emptyKafalat');

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø©
            let totalILS = 0, totalUSD = 0, totalJOD = 0;

            kafalat.forEach(k => {
                if (k.currency === 'USD') totalUSD += k.amount;
                else if (k.currency === 'JOD') totalJOD += k.amount;
                else totalILS += k.amount; // ILS Ø£Ùˆ Ø§ÙØªØ±Ø§Ø¶ÙŠ
            });

            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
            document.getElementById('childTotalILS').textContent = formatCurrency(totalILS, 'ILS');
            document.getElementById('childTotalUSD').textContent = formatCurrency(totalUSD, 'USD');
            document.getElementById('childTotalJOD').textContent = formatCurrency(totalJOD, 'JOD');

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù„ÙŠ Ù…Ø§ÙÙŠÙ‡Ù† ÙƒÙØ§Ù„Ø§Øª
            document.getElementById('childTotalILS').style.display = totalILS > 0 ? 'block' : 'none';
            document.getElementById('childTotalUSD').style.display = totalUSD > 0 ? 'block' : 'none';
            document.getElementById('childTotalJOD').style.display = totalJOD > 0 ? 'block' : 'none';

            if (kafalat.length === 0) {
                listContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                hideLoading();
                return;
            }

            emptyState.classList.add('hidden');

            let html = '';
            kafalat.forEach(kafala => {
                const currencySymbol = kafala.currency === 'USD' ? '$' : kafala.currency === 'JOD' ? 'Ø¯.Ø£' : 'â‚ª';
                html += `
                    <div class="kafala-item animate-fade-in">
                        <div class="kafala-icon">ğŸ’°</div>
                        <div class="kafala-details">
                            <div class="kafala-org">${kafala.organization}</div>
                            <div class="kafala-date">${formatDate(kafala.date)} ${kafala.notes ? 'â€¢ ' + kafala.notes : ''}</div>
                        </div>
                        <div class="kafala-amount" style="display: flex; flex-direction: column; align-items: flex-end;">
                            <span style="font-weight: 700; color: var(--success);">${kafala.amount.toLocaleString('ar-SA')}</span>
                            <span style="font-size: 12px; color: var(--gray);">${currencySymbol}</span>
                        </div>
                        <button class="btn-small btn-danger" onclick="handleDeleteKafala('${kafala.id}')">Ø­Ø°Ù</button>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
            hideLoading();
        }

        window.goBack = function() {
            window.location.href = 'index.html';
        };

        window.openAddKafalaModal = function() {
            document.getElementById('addKafalaModal').classList.add('active');
            document.getElementById('kafalaDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('kafalaOrg').focus();
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø© Ù„Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            selectCurrency(null, 'ILS', 'Ø´ÙŠÙƒÙ„ â‚ª');
        };

        window.closeAddKafalaModal = function() {
            document.getElementById('addKafalaModal').classList.remove('active');
            document.getElementById('kafalaOrg').value = '';
            document.getElementById('kafalaAmount').value = '';
            document.getElementById('kafalaNotes').value = '';
            document.getElementById('suggestions').classList.add('hidden');
        };

        window.toggleCurrencyMenu = function() {
            const menu = document.getElementById('currencyMenu');
            const arrow = document.getElementById('currencyArrow');
            
            if (menu.style.visibility === 'hidden' || menu.style.visibility === '') {
                menu.style.opacity = '1';
                menu.style.visibility = 'visible';
                menu.style.transform = 'translateY(0)';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                menu.style.opacity = '0';
                menu.style.visibility = 'hidden';
                menu.style.transform = 'translateY(-10px)';
                arrow.style.transform = 'rotate(0deg)';
            }
        };

        window.selectCurrency = function(element, code, display) {
            document.getElementById('selectedCurrency').value = code;
            document.getElementById('currencyText').textContent = display;
            toggleCurrencyMenu();
        };

        window.showSuggestions = function() {
            const input = document.getElementById('kafalaOrg').value.toLowerCase();
            const suggestionsDiv = document.getElementById('suggestions');

            if (!input || organizations.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }

            const filtered = organizations.filter(org => org.toLowerCase().includes(input));

            if (filtered.length > 0) {
                suggestionsDiv.innerHTML = filtered.map(org => 
                    `<div class="suggestion-item" onclick="selectOrg('${org}')">${org}</div>`
                ).join('');
                suggestionsDiv.classList.remove('hidden');
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        };

        window.selectOrg = function(org) {
            document.getElementById('kafalaOrg').value = org;
            document.getElementById('suggestions').classList.add('hidden');
        };

        window.handleAddKafala = async function() {
            const org = document.getElementById('kafalaOrg').value.trim();
            const amount = document.getElementById('kafalaAmount').value;
            const date = document.getElementById('kafalaDate').value;
            const notes = document.getElementById('kafalaNotes').value.trim();
            const currency = document.getElementById('selectedCurrency').value;

            const success = await addKafala(childId, org, amount, date, notes, currency);
            if (success) {
                closeAddKafalaModal();
                await loadKafalatList();
            }
        };

        window.handleDeleteKafala = async function(kafalaId) {
            const success = await deleteKafala(childId, kafalaId);
            if (success) {
                await loadKafalatList();
            }
        };

        // Close modal on outside click
        document.getElementById('addKafalaModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddKafalaModal();
        });

        // Close currency menu when clicking outside
        document.addEventListener('click', function(e) {
            const currencyBtn = document.getElementById('currencyBtn');
            const currencyMenu = document.getElementById('currencyMenu');
            if (!currencyBtn.contains(e.target) && !currencyMenu.contains(e.target)) {
                currencyMenu.style.opacity = '0';
                currencyMenu.style.visibility = 'hidden';
                currencyMenu.style.transform = 'translateY(-10px)';
                document.getElementById('currencyArrow').style.transform = 'rotate(0deg)';
            }
        });
    </script>
</body>
</html>
